<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>SENTINELA // REDE DE INFLUÃŠNCIA v2</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@400;600;700&display=swap');

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: #070b14;
    color: #c8d8e8;
    font-family: 'Share Tech Mono', monospace;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
  }

  /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #header {
    position: absolute; top: 0; left: 0; right: 0; z-index: 100;
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 18px;
    background: linear-gradient(180deg, rgba(7,11,20,0.98) 0%, rgba(7,11,20,0) 100%);
    border-bottom: 1px solid rgba(0,212,170,0.15);
  }
  #header .logo {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700; font-size: 20px; letter-spacing: 4px;
    color: #00d4aa;
    text-shadow: 0 0 20px rgba(0,212,170,0.6);
  }
  #header .logo span { color: #ff3a5c; }
  #header .status { font-size: 11px; color: #4a6a7a; letter-spacing: 2px; }
  #header .status .dot {
    display: inline-block; width: 6px; height: 6px;
    background: #00d4aa; border-radius: 50%;
    animation: pulse 2s infinite;
    margin-right: 6px; vertical-align: middle;
  }

  /* â”€â”€ FILTER PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #filters {
    position: absolute; top: 52px; left: 18px; z-index: 50;
    display: flex; gap: 8px; align-items: center;
  }
  .filter-label { font-size: 10px; color: #4a6a7a; letter-spacing: 2px; }
  .filter-btn {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px; letter-spacing: 1px;
    padding: 4px 10px; border: 1px solid;
    background: transparent; cursor: pointer;
    transition: all 0.2s;
  }
  .filter-btn.all    { color: #c8d8e8; border-color: #2a3a4a; }
  .filter-btn.invest { color: #ff3a5c; border-color: #ff3a5c44; }
  .filter-btn.sanc   { color: #ff8800; border-color: #ff880044; }
  .filter-btn.risco  { color: #cc44ff; border-color: #cc44ff44; }
  .filter-btn.active, .filter-btn:hover { background: currentColor; color: #070b14 !important; }

  /* â”€â”€ STATS STRIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #stats {
    position: absolute; top: 52px; right: 18px; z-index: 50;
    display: flex; gap: 20px;
  }
  .stat { text-align: right; }
  .stat .val { font-size: 20px; font-weight: 700; }
  .stat .lbl { font-size: 9px; color: #4a6a7a; letter-spacing: 2px; }
  .stat.red   .val { color: #ff3a5c; text-shadow: 0 0 10px #ff3a5c66; }
  .stat.amber .val { color: #ff8800; text-shadow: 0 0 10px #ff880066; }
  .stat.cyan  .val { color: #00d4aa; text-shadow: 0 0 10px #00d4aa66; }

  /* â”€â”€ LEGEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #legend {
    position: absolute; bottom: 24px; left: 18px; z-index: 50;
    display: flex; flex-direction: column; gap: 5px;
  }
  .legend-item {
    display: flex; align-items: center; gap: 8px;
    font-size: 10px; color: #4a6a7a; letter-spacing: 1px;
  }
  .legend-dot {
    width: 10px; height: 10px; border-radius: 50%;
    flex-shrink: 0;
  }

  /* â”€â”€ TOOLTIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #tooltip {
    position: absolute; z-index: 200;
    background: rgba(7,11,20,0.96);
    border: 1px solid rgba(0,212,170,0.3);
    padding: 10px 14px; min-width: 220px; max-width: 300px;
    pointer-events: none; opacity: 0;
    transition: opacity 0.15s;
    font-size: 11px; line-height: 1.7;
    box-shadow: 0 0 30px rgba(0,212,170,0.1);
  }
  #tooltip .tt-name { font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:15px; margin-bottom:4px; }
  #tooltip .tt-row  { display:flex; justify-content:space-between; gap:12px; }
  #tooltip .tt-key  { color:#4a6a7a; }
  #tooltip .tt-val  { color:#c8d8e8; }
  #tooltip .tt-flag { display:inline-block; padding:1px 5px; margin:2px 2px 0 0; font-size:9px; letter-spacing:1px; }
  #tooltip .tt-flag.INVEST { background:#ff3a5c22; color:#ff3a5c; border:1px solid #ff3a5c44; }
  #tooltip .tt-flag.OK     { background:#00d4aa22; color:#00d4aa; border:1px solid #00d4aa44; }
  #tooltip .tt-flag.SANC   { background:#ff880022; color:#ff8800; border:1px solid #ff880044; }
  #tooltip .tt-flag.NEPOT  { background:#cc44ff22; color:#cc44ff; border:1px solid #cc44ff44; }

  /* â”€â”€ DETAIL PANEL (clique em nÃ³) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #detail {
    position: absolute; top: 50%; right: 18px;
    transform: translateY(-50%);
    width: 260px; z-index: 80;
    background: rgba(7,11,20,0.95);
    border: 1px solid rgba(0,212,170,0.2);
    padding: 16px; display: none;
    font-size: 11px; line-height: 1.8;
  }
  #detail .d-title { font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:16px; margin-bottom:10px; color:#00d4aa; word-break:break-word; }
  #detail .d-close { position:absolute; top:10px; right:12px; cursor:pointer; color:#4a6a7a; font-size:16px; }
  #detail .d-close:hover { color:#ff3a5c; }
  #detail .d-row  { display:flex; justify-content:space-between; border-bottom:1px solid rgba(0,212,170,0.06); padding:3px 0; }
  #detail .d-key  { color:#4a6a7a; font-size:10px; letter-spacing:1px; }
  #detail .d-val  { color:#c8d8e8; text-align:right; max-width:160px; word-break:break-word; }
  #detail .d-flags { margin-top:8px; }
  #detail .d-btn {
    display:block; width:100%; margin-top:10px; padding:7px;
    background:transparent; border:1px solid #ff3a5c66;
    color:#ff3a5c; font-family:'Share Tech Mono',monospace;
    font-size:11px; letter-spacing:2px; cursor:pointer;
    transition:all 0.2s;
  }
  #detail .d-btn:hover { background:#ff3a5c; color:#070b14; }

  /* â”€â”€ CANVAS / GRAPH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  svg { position:absolute; top:0; left:0; width:100%; height:100%; }

  .node-label {
    font-family:'Barlow Condensed',sans-serif;
    font-size:11px; font-weight:600; letter-spacing:0.5px;
    pointer-events:none; text-shadow:0 1px 4px rgba(0,0,0,0.9);
    paint-order: stroke;
    stroke: rgba(7,11,20,0.8);
    stroke-width: 3px;
  }
  .link { stroke-opacity:0.5; fill:none; }
  .link.INVESTIGADO { stroke:#ff3a5c; stroke-opacity:0.6; stroke-dasharray:none; }
  .link.VETTING_OK  { stroke:#00d4aa; stroke-opacity:0.35; stroke-dasharray:4,4; }
  .link.SANCIONADO  { stroke:#ff8800; stroke-opacity:0.7; stroke-width:2px; }
  .link.DOACAO      { stroke:#cc44ff; stroke-opacity:0.6; stroke-dasharray:2,3; }

  /* Grid de fundo */
  #bg-grid {
    position:absolute; top:0; left:0; right:0; bottom:0; pointer-events:none;
    background-image:
      linear-gradient(rgba(0,212,170,0.025) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,170,0.025) 1px, transparent 1px);
    background-size: 50px 50px;
    z-index: 0;
  }

  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
  @keyframes fadeIn { from{opacity:0;transform:translateY(-4px)} to{opacity:1;transform:none} }
  #detail { animation: fadeIn 0.2s ease; }
</style>
</head>
<body>

<div id="bg-grid"></div>

<div id="header">
  <div class="logo">SENTINELA<span>//</span>REDE</div>
  <div class="status"><span class="dot"></span>SISTEMA ATIVO // ANÃLISE EM CURSO</div>
</div>

<div id="filters">
  <span class="filter-label">FILTRO:</span>
  <button class="filter-btn all active"   onclick="applyFilter('all')">TODOS</button>
  <button class="filter-btn invest"       onclick="applyFilter('investigado')">INVESTIGADOS</button>
  <button class="filter-btn sanc"         onclick="applyFilter('sancionado')">SANCIONADOS</button>
  <button class="filter-btn risco"        onclick="applyFilter('alto_risco')">ALTO RISCO</button>
</div>

<div id="stats">
  <div class="stat red">
    <div class="val" id="stat-investigados">0</div>
    <div class="lbl">INVESTIGADOS</div>
  </div>
  <div class="stat amber">
    <div class="val" id="stat-alertas">0</div>
    <div class="lbl">ALERTAS</div>
  </div>
  <div class="stat cyan">
    <div class="val" id="stat-nodes">0</div>
    <div class="lbl">ENTIDADES</div>
  </div>
</div>

<div id="legend">
  <div class="legend-item"><div class="legend-dot" style="background:#ff3a5c"></div>INVESTIGADO</div>
  <div class="legend-item"><div class="legend-dot" style="background:#ff8800"></div>SANCIONADO (CEIS/CNEP)</div>
  <div class="legend-item"><div class="legend-dot" style="background:#cc44ff"></div>DOAÃ‡ÃƒO ELEITORAL</div>
  <div class="legend-item"><div class="legend-dot" style="background:#00d4aa"></div>VETTING OK</div>
  <div class="legend-item"><div class="legend-dot" style="background:#3a9eff"></div>CENTRAL (MUNICÃPIO)</div>
</div>

<div id="tooltip"></div>

<div id="detail">
  <span class="d-close" onclick="closeDetail()">âœ•</span>
  <div class="d-title" id="d-name">â€”</div>
  <div id="d-rows"></div>
  <div class="d-flags" id="d-flags"></div>
  <button class="d-btn" id="d-btn-denuncia" onclick="openDenuncia()">ğŸ“‹ GERAR DENÃšNCIA</button>
</div>

<svg id="graph"></svg>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script>

// â”€â”€ DADOS (substituir por fetch() ao endpoint FastAPI quando disponÃ­vel) â”€
const graphData = window.__SENTINELA_DATA__ || {
  nodes: [
    { id: "RIO_BRANCO", label: "RIO BRANCO", type: "municipio",
      valor_total: 50000000, flags: [], alertas: 0 },

    { id: "EMPRESA_MUNICIPAL_DE", label: "EMPRESA MUNICIPAL DE", type: "empresa",
      valor_total: 1200000, flags: ["INVESTIGADO"], alertas: 2,
      cnpj: "00.000.000/0001-00", contratos: 3 },

    { id: "CONSTRUTORA_MIRANDA", label: "CONSTRUTORA MIRANDA", type: "empresa",
      valor_total: 850000, flags: ["INVESTIGADO","SANCIONADO"], alertas: 4,
      cnpj: "11.111.111/0001-11", contratos: 2 },

    { id: "FR_OLIVEIRA_LIMPEZA", label: "F R OLIVEIRA LIMPEZA", type: "empresa",
      valor_total: 320000, flags: ["VETTING_OK"], alertas: 0,
      cnpj: "22.222.222/0001-22", contratos: 5 },

    { id: "JG_MEDEIROS", label: "J G DE MEDEIROS LTDA", type: "empresa",
      valor_total: 2100000, flags: ["INVESTIGADO","FRACIONAMENTO"], alertas: 6,
      cnpj: "33.333.333/0001-33", contratos: 8 },

    { id: "EURO_CONSTRUCOES", label: "EURO CONSTRUÃ‡Ã•ES LTD", type: "empresa",
      valor_total: 750000, flags: ["INVESTIGADO"], alertas: 1,
      cnpj: "44.444.444/0001-44", contratos: 2 },

    { id: "APURINA_LTD", label: "APURINA LTD", type: "empresa",
      valor_total: 480000, flags: ["VETTING_OK"], alertas: 0,
      cnpj: "55.555.555/0001-55", contratos: 1 },

    { id: "AK_COMERCIO", label: "AK COMÃ‰RCIO SERVIÃ‡O", type: "empresa",
      valor_total: 990000, flags: ["INVESTIGADO","DOACAO"], alertas: 3,
      cnpj: "66.666.666/0001-66", contratos: 4 },

    { id: "MASTER_SERVICES", label: "MASTER SERVICES LTDA", type: "empresa",
      valor_total: 1500000, flags: ["SANCIONADO"], alertas: 5,
      cnpj: "77.777.777/0001-77", contratos: 6 },

    { id: "FR_PAULA_OLIVEIRA", label: "F R PAULA OLIVEIRA SO", type: "empresa",
      valor_total: 260000, flags: ["VETTING_OK"], alertas: 0,
      cnpj: "88.888.888/0001-88", contratos: 1 },

    { id: "NK_CONSTRUCOES", label: "NK CONSTRUÃ‡Ã•ES LTDA", type: "empresa",
      valor_total: 630000, flags: ["INVESTIGADO"], alertas: 2,
      cnpj: "99.999.999/0001-99", contratos: 3 },

    { id: "ENCRAVO_SERVICO_B", label: "ENCRAVO SERVIÃ‡O B", type: "empresa",
      valor_total: 410000, flags: ["INVESTIGADO"], alertas: 1,
      cnpj: "10.101.010/0001-10", contratos: 2 },
  ],
  links: [
    { source:"RIO_BRANCO", target:"EMPRESA_MUNICIPAL_DE", label:"INVESTIGADO",   tipo:"INVESTIGADO" },
    { source:"RIO_BRANCO", target:"CONSTRUTORA_MIRANDA",  label:"INVESTIGADO",   tipo:"INVESTIGADO" },
    { source:"RIO_BRANCO", target:"FR_OLIVEIRA_LIMPEZA",  label:"VETTING: OK",   tipo:"VETTING_OK"  },
    { source:"RIO_BRANCO", target:"JG_MEDEIROS",          label:"INVESTIGADO",   tipo:"INVESTIGADO" },
    { source:"RIO_BRANCO", target:"EURO_CONSTRUCOES",     label:"INVESTIGADO",   tipo:"INVESTIGADO" },
    { source:"RIO_BRANCO", target:"APURINA_LTD",          label:"VETTING: OK",   tipo:"VETTING_OK"  },
    { source:"RIO_BRANCO", target:"AK_COMERCIO",          label:"DOAÃ‡ÃƒO TSE",    tipo:"DOACAO"      },
    { source:"RIO_BRANCO", target:"MASTER_SERVICES",      label:"SANCIONADO",    tipo:"SANCIONADO"  },
    { source:"RIO_BRANCO", target:"FR_PAULA_OLIVEIRA",    label:"VETTING: OK",   tipo:"VETTING_OK"  },
    { source:"RIO_BRANCO", target:"NK_CONSTRUCOES",       label:"INVESTIGADO",   tipo:"INVESTIGADO" },
    { source:"RIO_BRANCO", target:"ENCRAVO_SERVICO_B",    label:"INVESTIGADO",   tipo:"INVESTIGADO" },
    { source:"CONSTRUTORA_MIRANDA", target:"JG_MEDEIROS", label:"SÃ“CIO COMUM",   tipo:"INVESTIGADO" },
    { source:"AK_COMERCIO", target:"MASTER_SERVICES",     label:"DOAÃ‡ÃƒO TSE",    tipo:"DOACAO"      },
  ]
};

// â”€â”€ SETUP D3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const svg    = d3.select("#graph");
const W      = window.innerWidth;
const H      = window.innerHeight;
const tooltip = d3.select("#tooltip");

const mainG = svg.append("g");

// Zoom
const zoom = d3.zoom()
  .scaleExtent([0.25, 4])
  .on("zoom", e => mainG.attr("transform", e.transform));
svg.call(zoom);

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nodeColor = d => {
  if (d.type === "municipio") return "#3a9eff";
  if (d.flags.includes("SANCIONADO")) return "#ff8800";
  if (d.flags.includes("INVESTIGADO")) return "#ff3a5c";
  if (d.flags.includes("DOACAO")) return "#cc44ff";
  return "#00d4aa";
};

const nodeRadius = d => {
  if (d.type === "municipio") return 28;
  const v = d.valor_total || 10000;
  return Math.max(10, Math.min(28, 8 + Math.log10(v) * 3));
};

const nodeGlow = d => {
  if (d.type === "municipio") return "drop-shadow(0 0 12px #3a9eff)";
  if (d.flags.includes("SANCIONADO")) return "drop-shadow(0 0 10px #ff8800)";
  if (d.flags.includes("INVESTIGADO")) return "drop-shadow(0 0 8px #ff3a5c)";
  return "drop-shadow(0 0 6px #00d4aa44)";
};

const fmt = v => v >= 1e6
  ? `R$ ${(v/1e6).toFixed(1)}M`
  : `R$ ${v.toLocaleString('pt-BR')}`;

// â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nInvest = graphData.nodes.filter(n => n.flags.includes("INVESTIGADO")).length;
const nAlertas = graphData.nodes.reduce((a,n) => a + (n.alertas||0), 0);
document.getElementById("stat-investigados").textContent = nInvest;
document.getElementById("stat-alertas").textContent = nAlertas;
document.getElementById("stat-nodes").textContent = graphData.nodes.length;

// â”€â”€ LINKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const link = mainG.append("g").attr("class", "links")
  .selectAll("line")
  .data(graphData.links)
  .join("line")
    .attr("class", d => `link ${d.tipo}`)
    .attr("stroke-width", d => d.tipo === "SANCIONADO" ? 2.5 : 1.5);

// Tooltip em hover das arestas (FIX: labels estÃ¡ticos removidos)
link
  .on("mouseover", (event, d) => {
    const colors = { INVESTIGADO:"#ff3a5c", VETTING_OK:"#00d4aa", SANCIONADO:"#ff8800", DOACAO:"#cc44ff" };
    tooltip
      .style("opacity", 1)
      .style("border-color", (colors[d.tipo] || "#4a6a7a") + "88")
      .html(`<div style="color:${colors[d.tipo]||'#c8d8e8'};font-weight:700;font-size:13px;">${d.label}</div>
             <div style="color:#4a6a7a;font-size:10px;">${d.source.id || d.source} â†’ ${d.target.id || d.target}</div>`);
  })
  .on("mousemove", event => {
    tooltip
      .style("left", (event.pageX + 14) + "px")
      .style("top",  (event.pageY - 20) + "px");
  })
  .on("mouseout", () => tooltip.style("opacity", 0));

// â”€â”€ NODES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const node = mainG.append("g").attr("class", "nodes")
  .selectAll("g")
  .data(graphData.nodes)
  .join("g")
    .attr("class", "node-group")
    .style("cursor", "pointer")
    .call(d3.drag()
      .on("start", (event, d) => {
        if (!event.active) sim.alphaTarget(0.3).restart();
        d.fx = d.x; d.fy = d.y;
      })
      .on("drag", (event, d) => { d.fx = event.x; d.fy = event.y; })
      .on("end", (event, d) => {
        if (!event.active) sim.alphaTarget(0);
        d.fx = null; d.fy = null;
      })
    );

// Anel externo (alerta badge)
node.filter(d => d.alertas > 0)
  .append("circle")
    .attr("r", d => nodeRadius(d) + 5)
    .attr("fill", "none")
    .attr("stroke", d => nodeColor(d))
    .attr("stroke-width", 1)
    .attr("stroke-opacity", 0.3)
    .attr("stroke-dasharray", "3,3");

// CÃ­rculo principal
node.append("circle")
  .attr("r", nodeRadius)
  .attr("fill", d => d.type === "municipio" ? "rgba(58,158,255,0.15)" : "rgba(7,11,20,0.8)")
  .attr("stroke", nodeColor)
  .attr("stroke-width", d => d.type === "municipio" ? 2.5 : 1.5)
  .style("filter", nodeGlow);

// Ãcone central (losango para empresas investigadas, ponto para ok)
node.filter(d => d.type !== "municipio")
  .append("rect")
    .attr("width", d => d.flags.includes("INVESTIGADO") || d.flags.includes("SANCIONADO") ? 8 : 5)
    .attr("height", d => d.flags.includes("INVESTIGADO") || d.flags.includes("SANCIONADO") ? 8 : 5)
    .attr("x", d => -(d.flags.includes("INVESTIGADO") ? 4 : 2.5))
    .attr("y", d => -(d.flags.includes("INVESTIGADO") ? 4 : 2.5))
    .attr("fill", nodeColor)
    .attr("transform", "rotate(45)");

// Badge de alertas
node.filter(d => d.alertas > 1)
  .append("text")
    .attr("x", d => nodeRadius(d) * 0.7)
    .attr("y", d => -nodeRadius(d) * 0.7)
    .attr("font-size", "9px")
    .attr("font-family", "'Share Tech Mono', monospace")
    .attr("fill", "#ff3a5c")
    .attr("text-anchor", "middle")
    .attr("dominant-baseline", "middle")
    .text(d => d.alertas);

// Label do nÃ³ (sempre visÃ­vel, sem sobreposiÃ§Ã£o de edge labels)
node.append("text")
  .attr("class", "node-label")
  .attr("y", d => nodeRadius(d) + 13)
  .attr("text-anchor", "middle")
  .attr("fill", nodeColor)
  .text(d => {
    const label = d.label || d.id;
    return label.length > 18 ? label.substring(0, 16) + "â€¦" : label;
  });

// â”€â”€ TOOLTIP nos nÃ³s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
node
  .on("mouseover", (event, d) => {
    const flagsHTML = d.flags.map(f => {
      const cls = f === "INVESTIGADO" ? "INVEST" : f === "SANCIONADO" ? "SANC" : f === "DOACAO" ? "NEPOT" : "OK";
      return `<span class="tt-flag ${cls}">${f}</span>`;
    }).join("");

    tooltip
      .style("opacity", 1)
      .html(`
        <div class="tt-name" style="color:${nodeColor(d)}">${d.label}</div>
        ${d.cnpj ? `<div class="tt-row"><span class="tt-key">CNPJ</span><span class="tt-val">${d.cnpj}</span></div>` : ""}
        <div class="tt-row"><span class="tt-key">VALOR TOTAL</span><span class="tt-val">${fmt(d.valor_total)}</span></div>
        <div class="tt-row"><span class="tt-key">CONTRATOS</span><span class="tt-val">${d.contratos || 0}</span></div>
        <div class="tt-row"><span class="tt-key">ALERTAS</span><span class="tt-val" style="color:#ff3a5c">${d.alertas}</span></div>
        <div style="margin-top:5px">${flagsHTML}</div>
      `);
  })
  .on("mousemove", event => {
    tooltip
      .style("left", (event.pageX + 14) + "px")
      .style("top",  (event.pageY - 20) + "px");
  })
  .on("mouseout", () => tooltip.style("opacity", 0))
  .on("click", (event, d) => {
    event.stopPropagation();
    openDetail(d);
  });

// â”€â”€ SIMULATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const sim = d3.forceSimulation(graphData.nodes)
  .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(120))
  .force("charge", d3.forceManyBody().strength(-800).distanceMax(500))  // â† FIX: era -300
  .force("center", d3.forceCenter(W / 2, H / 2))
  .force("collision", d3.forceCollide(d => nodeRadius(d) + 20))          // â† FIX: evita sobreposiÃ§Ã£o
  .on("tick", () => {
    link
      .attr("x1", d => d.source.x)
      .attr("y1", d => d.source.y)
      .attr("x2", d => d.target.x)
      .attr("y2", d => d.target.y);

    node.attr("transform", d => `translate(${d.x},${d.y})`);
  });

// â”€â”€ FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentFilter = 'all';
function applyFilter(tipo) {
  currentFilter = tipo;

  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`.filter-btn.${tipo === 'all' ? 'all' : tipo === 'investigado' ? 'invest' : tipo === 'sancionado' ? 'sanc' : 'risco'}`)
    .classList.add('active');

  node.transition().duration(300)
    .style("opacity", d => {
      if (tipo === 'all') return 1;
      if (d.type === 'municipio') return 1;
      if (tipo === 'investigado') return d.flags.includes("INVESTIGADO") ? 1 : 0.08;
      if (tipo === 'sancionado')  return d.flags.includes("SANCIONADO")  ? 1 : 0.08;
      if (tipo === 'alto_risco')  return d.alertas >= 3 ? 1 : 0.08;
      return 1;
    });

  link.transition().duration(300)
    .style("opacity", d => {
      if (tipo === 'all') return null;
      const srcFlag = (typeof d.source === 'object' ? d.source : graphData.nodes.find(n=>n.id===d.source))?.flags || [];
      const tgtFlag = (typeof d.target === 'object' ? d.target : graphData.nodes.find(n=>n.id===d.target))?.flags || [];
      if (tipo === 'investigado') return srcFlag.includes("INVESTIGADO")||tgtFlag.includes("INVESTIGADO") ? 0.7 : 0.03;
      if (tipo === 'sancionado')  return srcFlag.includes("SANCIONADO") ||tgtFlag.includes("SANCIONADO")  ? 0.8 : 0.03;
      return null;
    });
}

// â”€â”€ DETAIL PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedNode = null;
function openDetail(d) {
  selectedNode = d;
  document.getElementById("d-name").textContent = d.label;
  document.getElementById("d-name").style.color = nodeColor(d);

  const rows = [
    ["TIPO",       d.type === "municipio" ? "MUNICÃPIO" : "EMPRESA"],
    ["CNPJ",       d.cnpj || "N/D"],
    ["CONTRATOS",  d.contratos || 0],
    ["VALOR TOTAL",fmt(d.valor_total || 0)],
    ["ALERTAS",    d.alertas || 0],
  ];

  document.getElementById("d-rows").innerHTML = rows.map(([k,v]) =>
    `<div class="d-row"><span class="d-key">${k}</span><span class="d-val">${v}</span></div>`
  ).join("");

  const flagsHTML = (d.flags || []).map(f => {
    const cls = f === "INVESTIGADO" ? "INVEST" : f === "SANCIONADO" ? "SANC" : "NEPOT";
    return `<span class="tt-flag ${cls}" style="display:inline-block;padding:2px 7px;margin:2px;font-size:10px">${f}</span>`;
  }).join("");

  document.getElementById("d-flags").innerHTML = flagsHTML || '<span style="color:#4a6a7a;font-size:10px">SEM FLAGS</span>';

  const btn = document.getElementById("d-btn-denuncia");
  btn.style.display = d.flags.includes("INVESTIGADO") || d.flags.includes("SANCIONADO") ? "block" : "none";

  const panel = document.getElementById("detail");
  panel.style.display = "block";
}

function closeDetail() {
  document.getElementById("detail").style.display = "none";
  selectedNode = null;
}

function openDenuncia() {
  if (!selectedNode) return;
  const text = `DENÃšNCIA â€” SISTEMA SENTINELA\n\nEmpresa: ${selectedNode.label}\nCNPJ: ${selectedNode.cnpj || 'N/D'}\nFlags: ${selectedNode.flags.join(', ')}\nValor Total: ${fmt(selectedNode.valor_total)}\n\nFonte: Portal da TransparÃªncia de Rio Branco\nData: ${new Date().toLocaleDateString('pt-BR')}`;
  const w = window.open('', '_blank');
  w.document.write(`<pre style="font-family:monospace;padding:20px;white-space:pre-wrap">${text}</pre>`);
  w.document.close();
}

// Clique fora fecha detail
svg.on("click", closeDetail);

// Resize
window.addEventListener('resize', () => {
  sim.force("center", d3.forceCenter(window.innerWidth/2, window.innerHeight/2));
  sim.alpha(0.1).restart();
});
</script>
</body>
</html>
